@page
@model AspNetCoreVerifiableCredentials.Pages.VerifierModel
@{
    ViewData["Title"] = "Verifier";
}

<div class="content-card">

    <div class="header-logo-title">
        <img src="HippoLogo.png" />
        <h1>Verification of ID</h1>
    </div>

    <h2 class="main-action-title" style="text-align: center;">Verifiable Credential Presentation</h2>

    <div class="small-instruction text-center" style="margin-bottom: 30px;">
        <p style="margin: 0 0 5px 0;">Presentation request for type <b>@ViewData["CredentialType"]</b></p>
        <p style="margin: 0; font-size: 12px; color: #888;">
            Accepted Issuers: @string.Join(", ", (string[])ViewData["acceptedIssuers"])
        </p>
    </div>

<div id="before-qr-block" style="text-align: center;">
    <div style="display: flex; align-items: center; justify-content: center; gap: 20px; margin-bottom: 25px;">
        <button type="button" id="verify-credential" class="button" style="flex-shrink: 0;">Verify an ID</button>
        <button type="button" id="check-result" class="button" style="display:none; flex-shrink: 0;">Check Result</button>

        <div style="display:none; text-align: left; font-size: 14px; line-height: 1.5;">
            @if (!string.IsNullOrWhiteSpace((string)ViewData["PhotoClaimName"]))
            {
                <input type="checkbox" id="useFaceCheck" name="useFaceCheck" @((bool)ViewData["useFaceCheck"] ? "checked" :
                                                                                             "")>
                <label for="useFaceCheck" id="labelFaceCheck"> Use FaceCheck</label>
            }
            else
            {
                <input type="checkbox" id="useFaceCheck" name="useFaceCheck" value="0" style="display:none">
                <label for="useFaceCheck" id="labelFaceCheck" style="display:none"> Use FaceCheck</label>
            }
            <br />
            <input type="checkbox" id="useConstraints" name="useConstraints" @((bool)ViewData["useConstraints"] ?
                                                                                             "checked" : "")>
            <label for="useConstraints" id="labelConstraints"> Use Constraints</label>
        </div>

    </div>


    <table id="constraints" style="display:none; width: 100%;" class="small-text">
        <tbody>
            <tr>
                <td>
                    Claim
                    <input type="text" id="claimName" name="claimName" placeholder="name of the claim"
                        value="@ViewData["constraintName"]">
                </td>
                <td>
                    Operator
                    <select name="constrainOp" id="constrainOp">
                        @if ("value" == (string)ViewData["constraintOp"])
                        {
                            <option selected>value</option>
                        }
                        else
                        {
                            <option>value</option>
                        }
                        @if ("contains" == (string)ViewData["constraintOp"])
                        {
                            <option selected>contains</option>
                        }
                        else
                        {
                            <option>contains</option>
                        }
                        @if ("startsWith" == (string)ViewData["constraintOp"])
                        {
                            <option selected>startsWith</option>
                        }
                        else
                        {
                            <option>startsWith</option>
                        }
                    </select>
                </td>
                <td>
                    Value
                    <input type="text" id="claimValue" name="claimValue" placeholder="claim value."
                        value="@ViewData["constraintValue"]">
                </td>
            </tr>
        </tbody>
    </table>
</div>

    <div id="auth-block" style="display:none; text-align: center;">

        <div id="message-wrapper" class="margin-bottom-75">
            <div id="message" class="small-instruction" style="color:#555; font-weight: bold;">@ViewData["Message"]
            </div>
        </div>

        <div id="qrcode" style="text-align:center;"></div>
@* 
        @if (!string.IsNullOrWhiteSpace((string)ViewData["PhotoClaimName"]))
        {
            <p id="qr-facecheck-message" class="tiny-text text-gray" style="margin-top: 15px;">Use FaceCheck</p>
        } *@
    </div>


    <script src="qrcode.min.js"></script>
    <script src="verifiedid.requestservice.client.js"></script>
    <script src="verifiedid.uihandler.js"></script>

    <script>
        // 1. Initial Manifest Fetch 
        fetch('api/issuer/get-manifest')
            .then(function (response) {
                response.text()
                    .catch(error => displayMessage(error))
                    .then(function (message) {
                        var manifest = JSON.parse(message);
                        // Set the logo to the small header size
                        document.querySelector('.header-logo-title img').src = manifest.display.card.logo.uri;
                    }).catch(error => { console.log(error.message); })
            }).catch(error => { console.log(error.message); })

        var qrcode = new QRCode("qrcode", { width: 150, height: 150 });
        var photoClaimName = '@ViewData["PhotoClaimName"]';

        document.getElementById('verify-credential').addEventListener('click', () => {
            var qp = '?faceCheck=' + (document.getElementById('useFaceCheck').checked ? '1' : '0');
            if (document.getElementById('useFaceCheck').checked) {
                qp += '&photoClaimName=' + photoClaimName;
            }
            if (true == document.getElementById('useConstraints').checked) {
                var claimName = document.getElementById('claimName').value;
                var claimValue = document.getElementById('claimValue').value;
                var constraintOp = document.getElementById('constrainOp').value;
                if (claimName && constraintOp && claimValue) {
                    qp += "&claim=" + claimName + "&op=" + constraintOp + "&value=" + claimValue;
                }
            }
            requestService.apiCreatePresentationRequest += qp;
            requestService.createPresentationRequest();

            // Manual UI State Switch (Used for initial transition)
            document.getElementById('before-qr-block').style.display = "none";
            document.getElementById('auth-block').style.display = "block";
        });

        document.getElementById('check-result').addEventListener('click', () => {
            requestService.pollRequestStatus(requestService.request.id);
        });

        function hideShowConstraints() {
            document.getElementById('constraints').style.display = (document.getElementById('useConstraints').checked ? "" : "none");
        }

        document.getElementById('useConstraints').addEventListener('click', () => {
            hideShowConstraints();
        });

        hideShowConstraints();
    </script>
</div>