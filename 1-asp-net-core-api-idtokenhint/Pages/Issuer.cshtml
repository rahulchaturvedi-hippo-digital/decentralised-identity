@page
@model AspNetCoreVerifiableCredentials.Pages.IssuerModel
@{
  ViewData["Title"] = "Issuer";
}
<div class="content-card">
    <div class="header-logo-title">
        <img id="logo" src="HippoLogo.png" />
        <h1>Verified ID Issuance</h1>
    </div>

    <a href="./" class="back-link">
        < Back to Start
    </a>

    <h2 class="main-action-title">Issue a new ID</h2>
    
    <p class="small-instruction" style="margin-bottom: 30px;">
        Issue an official digital ID credential via <b>HippoWallet</b>.
    </p>
    <div id="message-wrapper" class="margin-bottom-75" style="display: none">
      <i class="fas fa-user-check green icon-text-large margin-bottom-25"></i>
      <div id="message"></div>
    </div>
    <div id="input-block">
        <div id="name-block">
            <label for="firstName">First name</label>
            <input type="text" id="firstName" aria-label="First name"/>
            
            <label for="familyName">Surname</label>
            <input type="text" id="familyName" aria-label="Family name"/>
        </div>

        <div id="dob-block">
            <label for="dob">Date of birth</label>
            <input type="date" id="dob" aria-label="Date of birth" />
        </div>

    </div>
    
    <div id="auth-block" style="display: none; padding-top: 20px; border-top: 1px solid #eee;">
        <h3 style="font-size: 16px; margin-bottom: 15px; font-weight: bold; color: #3B2E58;">
            Open the Microsoft Authenticator app on your mobile device
        </h3>
        <ol style="padding-left: 20px; font-size: 14px; margin-top: 0;">
            <li>Use the Microsoft Authenticator App to scan the QR code below.</li>
            <li>When prompted, enter the PIN below into Microsoft Authenticator:</li>
        </ol>

        <div id="qrcode" style="text-align:center; display:none; margin-bottom: 20px;"></div>
        <div id="pinCode" style="display: none; text-align: center; font-size: 32px; font-weight: bold; letter-spacing: 5px; margin-top: 10px;">
            </div>
    </div>
    
    <button type="button" id="issue-credential" class="button" style="width: 100%; margin-top: 10px;">Issue an ID</button>
    
    <button type="button" id="check-result" class="button" style="display:none">Check Result</button>
    <button type="button" id="take-selfie" class="button" style="display:none">Take Selfie</button>
    <input type='file' id="imageUpload" accept="image/*" class="button" style="display:none" />
    <img id="selfie" width="240" height="320" style="display:none" />

    <script src="qrcode.min.js"></script>
    <script src="verifiedid.requestservice.client.js"></script>
    <script src="verifiedid.uihandler.js"></script>
<script>
  // ADDED: helper to validate yyyy-mm-dd (from <input type="date">)
  function getDobOrShowError() {
    const el = document.getElementById('dob');
    if (!el) return null;
    const val = (el.value || '').trim();
    if (!val) {
      alert('Please select your date of birth before issuing.');
      return null;
    }
    if (!/^\d{4}-\d{2}-\d{2}$/.test(val)) {
      alert('Date of birth must be in YYYY-MM-DD format.');
      return null;
    }
    return val;
  }

  // ADDED: simple helper to get a non-empty text field
  function getTextOrShowError(id, label) {
    const el = document.getElementById(id);
    if (!el) return '';
    const val = (el.value || '').trim();
    if (!val) {
      alert(`Please enter your ${label} before issuing.`);
      return '';
    }
    return val;
  }

  // ADDED: transparently append ?dob=&firstName=&familyName= when calling issuance API
  (function attachDobToIssuanceFetch() {
    const origFetch = window.fetch;
    window.fetch = function(input, init) {
      try {
        let url = (typeof input === 'string') ? input : input?.url;
        // only intercept the issuance endpoint; leave everything else untouched
        if (url && url.indexOf('/api/issuer/issuance-request') !== -1) {
          const dob = getDobOrShowError();
          if (!dob) {
            return Promise.reject(new Error('DOB is required for issuance'));
          }
          const firstName  = getTextOrShowError('firstName', 'first name');
          if (!firstName) {
            return Promise.reject(new Error('First name is required for issuance'));
          }
          const familyName = getTextOrShowError('familyName', 'family name');
          if (!familyName) {
            return Promise.reject(new Error('Family name is required for issuance'));
          }

          const u = new URL(url, window.location.origin);
          if (!u.searchParams.get('dob'))         u.searchParams.set('dob', dob);
          if (!u.searchParams.get('firstName'))  u.searchParams.set('firstName', firstName);
          if (!u.searchParams.get('familyName')) u.searchParams.set('familyName', familyName);

          input = (typeof input === 'string') ? u.toString() : new Request(u.toString(), input);
        }
      } catch (e) {
        console.warn('DOB/name append shim warning:', e);
      }
      return origFetch.call(this, input, init);
    };
  })();

  var qrcode = new QRCode("qrcode", { width: 150, height: 150 });
  var havePhotoClaim = false;

  fetch('api/issuer/get-manifest')
      .then(function (response) {
          response.text()
              .catch(error => displayMessage(error))
              .then(function (message) {
                  var manifest = JSON.parse(message);
                  document.getElementById('idTitle').innerHTML = "Issuance of " + manifest.display.card.title + " by " + manifest.display.card.issuedBy;
                  document.getElementById('idSubTitle').innerHTML = manifest.display.card.description;
                  document.getElementById('logo').src = manifest.display.card.logo.uri;
                  // if the manifest has a claim with type image/jp[e]g, then we should support adding a photo
                  if (message.includes("image/jp")) {
                      havePhotoClaim = true;
                      hideShowPhotoElements("");
                  }
              }).catch(error => { console.log(error.message); })
      }).catch(error => { console.log(error.message); })

  // backend will set ageOver18 true/false
  document.getElementById('issue-credential').addEventListener('click', () => {
      // this will show alerts if required fields missing
      const dob = getDobOrShowError();
      const firstName  = getTextOrShowError('firstName', 'first name');
      const familyName = getTextOrShowError('familyName', 'family name');
      if (!dob || !firstName || !familyName) {
          return; // don’t call backend if inputs invalid/empty
      }

      if ( havePhotoClaim ) {
          setUserPhoto();
          hideShowPhotoElements("none");
          // make sure the photo is sent to API in backend before we continue
          setTimeout(requestService.createIssuanceRequest(), 250);
      } else {
          requestService.createIssuanceRequest();
      }
  });

  document.getElementById('take-selfie').addEventListener('click', () => {
      document.getElementById("selfie").src = "";
      document.getElementById("selfie").style.display = "none";
      document.getElementById("imageUpload").style.display = "none";
      requestService.createSelfieRequest();
  });

  document.getElementById('check-result').addEventListener('click', () => {
      requestService.pollRequestStatus(requestService.request.id);
  });

  document.getElementById('imageUpload').addEventListener('change', function (e) {
      uploadImage(e)
  });
</script>

  </div>
