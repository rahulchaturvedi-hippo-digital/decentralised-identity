@page
@model AspNetCoreVerifiableCredentials.Pages.VerifierModel
@{
    ViewData["Title"] = "Presentation Verified";
}

<div class="content-card" style="max-width: 700px;">
    
    <div class="header-logo-title" style="justify-content: center;">
        <img src="HippoLogo.png" />
    </div>

    <h2 id="vcType" class="main-action-title" style="text-align: center;">VerifiedEmployee Presentation</h2>

    <div id="message-wrapper" class="margin-bottom-75 margin-top-25" style="display: block; text-align: left;">
        
        <div id="message" class="small-text text-center margin-bottom-25" style="font-weight: bold;"></div>
        
        <br />

        <h3 style="font-size: 18px; margin-bottom: 10px; font-weight: bold; color: #333;">Claims</h3>
        <table id="claims" style="width: 100%;">
            <thead>
                <tr>
                    <th style="width:25%; background-color: #333; color: white;">Claims</th>
                    <th style="background-color: #333; color: white;">Value</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>

        <br />

        <h3 style="font-size: 18px; margin: 25px 0 10px 0; font-weight: bold; color: #333;">VC Details</h3>
        <table id="vcinfo" style="width: 100%;">
            <thead>
                <tr>
                    <th style="width:25%; background-color: #333; color: white;">VC Details</th>
                    <th style="background-color: #333; color: white;">Value</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>

        <br />
    </div>

    <script src="verifiedid.requestservice.client.js"></script>
    <script src="verifiedid.uihandler.js"></script>

    <script>
        // Your existing JavaScript logic remains here to process the claims and populate the tables
        // ... (rest of your existing script, which handles getPresentationResult, drawClaimsTable, etc.)

        fetch('api/issuer/get-manifest')
            .then(function (response) {
                response.text()
                    .catch(error => displayMessage(error))
                    .then(function (message) {
                        var manifest = JSON.parse(message);
                        // Set the logo to the small header size
                        document.querySelector('.header-logo-title img').src = manifest.display.card.logo.uri;
                    }).catch(error => { console.log(error.message); })
            }).catch(error => { console.log(error.message); })

        // ... rest of your original functions (addTableRowLabel, drawClaimsTable, etc.) ...
        
        function addTableRowLabel(tbodyRef, key) {
            var row = tbodyRef.insertRow(0);
            (row.insertCell(0)).innerHTML = key;
            return row;
        }
        function addTableRow(tbodyRef, key, value) {
            var row = addTableRowLabel(tbodyRef, key);
            (row.insertCell(1)).innerHTML = value;
        }

        function drawClaimsTable(claims) {
            if (Object.keys(claims).length > 0) {
                var tbodyRef = document.getElementById('claims').getElementsByTagName('tbody')[0];
                var idx = 0;
                for (idx = Object.keys(claims).length - 1; idx >= 0; idx--) {
                    var claimName = Object.keys(claims)[idx];
                    if (claimName == "photo" || claimName == "picture") {
                        var img = document.createElement('img');
                        img.width = 100;
                        img.src = "data:image/*;base64," + decodeURI(claims[Object.keys(claims)[idx]]).replaceAll("_", "/").replaceAll("-", "+");
                        var row = addTableRowLabel(tbodyRef, claimName);
                        (row.insertCell(1)).appendChild(img);
                    } else {
                        addTableRow(tbodyRef, claimName, claims[Object.keys(claims)[idx]]);
                    }
                }
            }
        }
        function drawVcInfoTable(respMsg, payload) {
            if (Object.keys(payload).length > 0) {
                var tbodyRef = document.getElementById('vcinfo').getElementsByTagName('tbody')[0];
                var idx = 0;
                for (idx = Object.keys(payload).length - 1; idx >= 0; idx--) {
                    var claimName = Object.keys(payload)[idx];
                    console.log(claimName);
                    if (claimName !== "claims") {
                        if (Object.keys(payload[Object.keys(payload)[idx]]).length > 0) {
                            addTableRow(tbodyRef, claimName, JSON.stringify(payload[Object.keys(payload)[idx]]))
                        } else {
                            addTableRow(tbodyRef, claimName, payload[Object.keys(payload)[idx]])
                        }
                    }
                }
                if (respMsg.jti) {
                    addTableRow(tbodyRef, "jti", respMsg.jti);
                }
                var vcSubject = respMsg.subject.split(":");
                addTableRow(tbodyRef, "subject", vcSubject[0] + ":" + vcSubject[1] + vcSubject[2] + "...");
                if (respMsg.revocationStatus) {
                    addTableRow(tbodyRef, "revocationStatus", respMsg.revocationStatus);
                }
                if (respMsg.domainValidation) {
                    addTableRow(tbodyRef, "domainValidation url", respMsg.domainValidation);
                }
                if (respMsg.matchConfidenceScore) {
                    addTableRow(tbodyRef, "faceCheck matchConfidenceScore", respMsg.matchConfidenceScore);
                }
            }
        }
        function getPresentationResult(requestId) {
            fetch(`${requestService.apiPollPresentationRequest}?id=${requestId}`)
                .then(response => response.text())
                .catch(error => document.getElementById("message").innerHTML = error)
                .then(response => {
                    if (response.length > 0) {
                        console.log(response)
                        respMsg = JSON.parse(response);
                        if (respMsg.status == 'presentation_verified') {
                            document.getElementById('vcType').innerText = respMsg.type[1] + " Presentation verified";
                            document.getElementById('message').innerHTML = "";
                            drawClaimsTable(respMsg.payload[0].claims);
                            drawVcInfoTable(respMsg, respMsg.payload[0]);
                        }
                    }
                })
        }


        function parseParms(str) {
            var pieces = str.split("&"), data = {}, i, parts;
            for (i = 0; i < pieces.length; i++) {
                parts = pieces[i].split("=");
                if (parts.length < 2) {
                    parts.push("");
                }
                data[decodeURIComponent(parts[0])] = decodeURIComponent(parts[1]);
            }
            return data;
        }

        window.onload = function () {
            var requestId = parseParms(document.location.search.substring(1)).id;
            if (requestId) {
                getPresentationResult(requestId)
            }
        }
    </script>
</div>
<div id="payload" style="text-align:left; display:none; margin:25px"></div>